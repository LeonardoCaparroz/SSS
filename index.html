<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Terminal S.E.S - CRT Mode v4.2 (Root Access Update)</title>

    <style>
        /* ==========================================================================
           CSS Styles -- Stylized and Polished
           ========================================================================== */
        :root {
            --terminal-green: #00FF41;
            --terminal-bg: #0a120e;
            --terminal-header-bg: #00a82b;
            --terminal-header-text: #0a120e;
            --scanline-opacity: 0.15;
            --glow-blur: 7px;
            --error-red: #ff6b6b;
            --success-cyan: #4dffff;
            --warning-yellow: #ffcc33;
            --terminal-border-color: #1a2e25;
            --terminal-border-highlight: rgba(0, 255, 65, 0.3);
            --transition-speed: 0.25s;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Consolas', 'Lucida Console', 'Courier New', monospace;
        }

        body.animating {
            cursor: wait;
        }

        #crt-container {
            position: relative;
            width: 95vmin;
            height: calc(95vmin * (3 / 4));
            max-width: 100vw;
            max-height: 100vh;
            background-color: var(--terminal-bg);
            box-shadow: 0 0 2px var(--terminal-border-highlight), inset 0 0 5px rgba(0, 0, 0, 0.7), 0 0 25px rgba(0, 255, 65, 0.1), 0 0 0 3px var(--terminal-border-color), 0 0 0 5px #0a140f;
            overflow: hidden;
            border-radius: 8px; /* Slightly more rounded corners */
        }

        #crt-container::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(transparent 0px, transparent 1px, rgba(0, 0, 0, var(--scanline-opacity)) 2px, rgba(0, 0, 0, var(--scanline-opacity)) 3px);
            pointer-events: none;
            z-index: 3; /* Above logo */
        }
        
        #logo {
            position: absolute;
            top: 15px;
            left: 20px;
            width: 80px;
            height: auto;
            opacity: 0.4;
            /* Green filter effect */
            filter: grayscale(100%) sepia(100%) hue-rotate(55deg) saturate(500%) brightness(0.7);
            z-index: 2;
        }

        #terminal {
            width: 100%;
            height: 100%;
            padding: 25px;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            color: var(--terminal-green);
            font-size: 18px;
            line-height: 1.6;
            text-shadow: 0 0 var(--glow-blur) var(--terminal-green);
        }

        #terminal:focus {
            outline: none;
        }

        #terminal::-webkit-scrollbar {
            width: 8px;
        }

        #terminal::-webkit-scrollbar-track {
            background: transparent;
        }

        #terminal::-webkit-scrollbar-thumb {
            background-color: var(--terminal-green);
            border-radius: 4px;
            box-shadow: 0 0 var(--glow-blur) var(--terminal-green);
        }

        #output {
            flex-grow: 1;
            white-space: pre-wrap;
            transition: opacity var(--transition-speed) ease-in-out;
            opacity: 1;
        }

        #output.transition-out {
            opacity: 0;
        }

        #output.transition-in {
            opacity: 1;
        }

        .view-container {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .view-header-section {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            width: 100%;
        }

        .view-icon {
            margin-right: 25px;
            flex-shrink: 0;
            padding-top: 5px; /* Align with header text */
        }

        .view-icon-placeholder {
            width: 64px;
            height: 64px;
            border: 3px solid var(--terminal-border-color);
            background-color: rgba(15, 25, 21, 0.5);
            box-shadow: inset 0 0 8px rgba(0, 255, 65, 0.15);
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .view-header-content {
            flex-grow: 1;
            text-align: left;
        }

        .view-header {
            background-color: var(--terminal-header-bg);
            color: var(--terminal-header-text);
            padding: 3px 10px;
            display: inline-block;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 15px;
            text-shadow: none;
        }

        .view-container[data-view="welcome"] {
            align-items: center;
        }
        .view-container[data-view="welcome"] .view-header-section { justify-content: center; }
        .view-container[data-view="welcome"] .view-icon { margin-right: 0; margin-bottom: 20px; }
        .view-container[data-view="welcome"] .view-header-content { text-align: center; flex-grow: 0; width: auto; }

        .description-text {
            margin-bottom: 20px;
            line-height: 1.4;
            max-width: 60ch;
        }

        .menu-item, .list-item, .input-field, .button, .info-line {
            display: block;
            padding: 1px 0px;
            margin: 1px 0;
            cursor: default;
            position: relative;
            padding-left: 25px;
            min-height: 1.6em;
            text-align: left;
        }

        .selected::before {
            content: ">";
            position: absolute;
            left: 0px;
            top: 1px;
            display: inline-block;
            width: 20px;
            text-align: center;
            color: var(--terminal-green);
            text-shadow: 0 0 var(--glow-blur) var(--terminal-green);
            animation: blink-animation 1s steps(2, start) infinite;
        }

        .input-field {
            padding-left: 0;
            display: flex;
            align-items: center;
        }

        .input-field::before {
            content: "";
            display: inline-block;
            width: 20px;
            text-align: center;
            position: static;
            margin-right: 5px;
            flex-shrink: 0;
        }

        .input-field.selected::before {
            content: ">";
            color: var(--terminal-green);
            text-shadow: 0 0 var(--glow-blur) var(--terminal-green);
            animation: blink-animation 1s steps(2, start) infinite;
        }

        .input-field .label {
            display: inline-block;
            width: 12ch; /* Adjusted for longer labels */
            margin-right: 5px;
            flex-shrink: 0;
        }

        .input-field .value {
            flex-grow: 1;
            position: relative;
            min-width: 1ch;
        }

        .input-field .value.cursor::after {
            content: '_';
            animation: blink-animation 1s steps(2, start) infinite;
            display: inline;
            text-shadow: 0 0 var(--glow-blur) var(--terminal-green);
        }

        @keyframes blink-animation {
            to {
                visibility: hidden;
            }
        }

        .message {
            margin: 15px 0;
            padding: 10px 15px;
            border: 1px dashed;
            text-align: left;
        }

        .message.error { color: var(--error-red); border-color: var(--error-red); text-shadow: 0 0 var(--glow-blur) var(--error-red); }
        .message.success { color: var(--success-cyan); border-color: var(--success-cyan); text-shadow: 0 0 var(--glow-blur) var(--success-cyan); }
        .message.info { color: var(--warning-yellow); border-color: var(--warning-yellow); text-shadow: 0 0 var(--glow-blur) var(--warning-yellow); }

        .footer-hints {
            margin-top: auto;
            padding-top: 20px;
            font-size: 0.9em;
            color: var(--terminal-green);
            opacity: 0.7;
            text-align: center;
            width: 100%;
        }

        .ascii-art {
            white-space: pre;
            line-height: 1.1;
            margin-bottom: 20px;
            text-align: center;
            font-size: 0.8em;
        }

        .divider {
            border: none;
            height: 1px;
            background-color: var(--terminal-green);
            opacity: 0.5;
            margin: 15px 0;
            box-shadow: 0 0 var(--glow-blur) var(--terminal-green);
        }

        .login-result-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
        }

        .result-box {
            border: 1px solid var(--terminal-green);
            padding: 30px 40px;
            background-color: rgba(15, 25, 21, 0.8);
            box-shadow: 0 0 15px var(--terminal-green);
            max-width: 80%;
        }

        .result-box.error { border-color: var(--error-red); box-shadow: 0 0 15px var(--error-red); color: var(--error-red); text-shadow: 0 0 var(--glow-blur) var(--error-red); }
        .result-box.success { border-color: var(--success-cyan); box-shadow: 0 0 15px var(--success-cyan); color: var(--success-cyan); text-shadow: 0 0 var(--glow-blur) var(--success-cyan); }
        .result-box .result-message { font-size: 1.5em; font-weight: bold; margin-bottom: 25px; }
        .result-box .continue-prompt { font-size: 0.9em; opacity: 0.8; }

        .glitched-text {
            color: var(--terminal-green);
            text-shadow: 0 0 var(--glow-blur) var(--terminal-green);
            opacity: 0.7;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: calc(100% - 40px);
            vertical-align: bottom;
        }

        .text-bold { font-weight: bold; }
        textarea.email-body {
            background-color: rgba(15, 25, 21, 0.8);
            border: 1px solid var(--terminal-border-color);
            color: var(--terminal-green);
            text-shadow: 0 0 var(--glow-blur) var(--terminal-green);
            width: 100%;
            height: 150px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: inherit;
            padding: 10px;
            margin-top: 10px;
        }
        textarea.email-body:focus {
             outline: 1px solid var(--terminal-green);
             box-shadow: 0 0 10px var(--terminal-green);
        }

    </style>
</head>
<body>

    <div id="crt-container">
        <img id="logo" src="Logo Ordo Veritas.png" alt="Logo">
        <div id="terminal" tabindex="0">
            <div id="output"></div>
        </div>
    </div>

    <script>
        // ==========================================================================
        // CONFIGURATION
        // ==========================================================================
        const config = {
            companyName: "S.E.S",
            systemName: "TERMINAL OS v3.7 - SSS",
            users: {
                "convidado": { password: "convidado", level: 1 },
                "admin": { password: "seguranca", level: 2 },
                "root": { password: "chavemestra", level: 3 }
            },
            doors: {},
            emails: []
        };

        // ==========================================================================
        // TERMINAL STATE
        // ==========================================================================
        const state = {
            loggedIn: false, currentUser: null, currentLevel: 0, currentView: 'welcome',
            selectedIndex: 0,
            activeInputField: 'username',
            loginForm: { username: "", password: "" },
            adminForm: {}, // For multi-purpose admin forms
            message: { text: null, type: null, timeoutId: null },
            viewData: { emails: [], doors: [], selectedEmailId: null, selectedDoorName: null },
            navigationStack: [],
            isAnimating: false,
            glitchInterval: null,
            glitchChars: 'ABCDEFGHIJKLMNO0123456789!?#%&@*<>'
        };

        // ==========================================================================
        // DOM ELEMENTS
        // ==========================================================================
        const terminal = document.getElementById('terminal');
        const output = document.getElementById('output');
        const body = document.body;

        // ==========================================================================
        // ASCII ART
        // ==========================================================================
        const accessDenied = `
    ███╗   ██╗███████╗ ██████╗  █████╗ ██████╗  ██████╗ 
    ████╗  ██║██╔════╝██╔════╝ ██╔══██╗██╔══██╗██╔═══██╗
    ██╔██╗ ██║█████╗  ██║  ███╗███████║██║  ██║██║   ██║
    ██║╚██╗██║██╔══╝  ██║   ██║██╔══██║██║  ██║██║   ██║
    ██║ ╚████║███████╗╚██████╔╝██║  ██║██████╔╝╚██████╔╝
    ╚═╝  ╚═══╝╚══════╝ ╚═════╝ ╚═╝  ╚═╝╚═════╝  ╚═════╝ 
`;
        const accessGranted = `
    ██████╗ ███████╗██████╗ ███╗   ███╗██╗████████╗██╗██████╗  ██████╗ 
    ██╔══██╗██╔════╝██╔══██╗████╗ ████║██║╚══██╔══╝██║██╔══██╗██╔═══██╗
    ██████╔╝█████╗  ██████╔╝██╔████╔██║██║   ██║   ██║██║  ██║██║   ██║
    ██╔═══╝ ██╔══╝  ██╔══██╗██║╚██╔╝██║██║   ██║   ██║██║  ██║██║   ██║
    ██║     ███████╗██║  ██║██║ ╚═╝ ██║██║   ██║   ██║██████╔╝╚██████╔╝
    ╚═╝     ╚══════╝╚═╝  ╚═╝╚═╝     ╚═╝╚═╝   ╚═╝   ╚═╝╚═════╝  ╚═════╝ 
`;

        // ==========================================================================
        // UTILITY & NAVIGATION FUNCTIONS
        // ==========================================================================
        function displayMessage(text, type = 'info', duration = 3000) {
            if (state.message.timeoutId) clearTimeout(state.message.timeoutId);
            state.message = { text, type, timeoutId: null };
            render();
            if (duration > 0) {
                state.message.timeoutId = setTimeout(() => {
                    if (state.message.text === text) clearMessage();
                }, duration);
            }
        }
        function clearMessage(triggerRender = true) {
            if (state.message.timeoutId) clearTimeout(state.message.timeoutId);
            state.message = { text: null, type: null, timeoutId: null };
            if (triggerRender) render();
        }
        
        async function navigateTo(view, data = {}, pushToStack = true) {
            if (state.isAnimating) return;
            state.isAnimating = true;
            body.classList.add('animating');
            stopGlitchEffect();
            clearMessage(false);
            output.classList.add('transition-out');
            await new Promise(resolve => setTimeout(resolve, 250));
            
            if (pushToStack && state.currentView !== view) {
                state.navigationStack.push({ view: state.currentView, data: state.viewData });
            }

            state.currentView = view;
            state.viewData = { ...state.viewData, ...data };
            state.selectedIndex = 0;
            state.adminForm = {}; // Reset admin form on navigation
            
            render();
            if (view === 'email_list' || view === 'door_list') startGlitchEffect();
            
            output.classList.remove('transition-out');
            output.classList.add('transition-in');
            await new Promise(resolve => setTimeout(resolve, 250));
            output.classList.remove('transition-in');
            
            state.isAnimating = false;
            body.classList.remove('animating');
            terminal.scrollTop = 0;
            terminal.focus();
        }

        function navigateBack() {
            if (state.isAnimating) return;
            const previous = state.navigationStack.pop();
            if (previous) {
                navigateTo(previous.view, previous.data, false);
            } else if (state.loggedIn) {
                navigateTo('main_menu', {}, false);
            } else {
                navigateTo('welcome', {}, false);
            }
        }

        // ==========================================================================
        // GLITCH EFFECT FUNCTIONS
        // ==========================================================================
        function scrambleText(originalText) {
            let scrambled = '';
            for (let i = 0; i < originalText.length; i++) {
                if (originalText[i].match(/\s|[\[\]-]/) || Math.random() < 0.1) {
                    scrambled += originalText[i];
                } else {
                    scrambled += state.glitchChars[Math.floor(Math.random() * state.glitchChars.length)];
                }
            }
            return scrambled;
        }
        function startGlitchEffect() {
            stopGlitchEffect();
            state.glitchInterval = setInterval(() => {
                const glitchElements = output.querySelectorAll('.glitched-text[data-original-text]');
                if (glitchElements.length === 0) return;
                glitchElements.forEach(el => {
                    if (el && el.hasAttribute('data-original-text')) {
                        el.textContent = scrambleText(el.getAttribute('data-original-text'));
                    }
                });
            }, 100);
        }
        function stopGlitchEffect() {
            if (state.glitchInterval) clearInterval(state.glitchInterval);
            state.glitchInterval = null;
        }

        // ==========================================================================
        // DATA MANAGEMENT FUNCTIONS (Root Access)
        // ==========================================================================
        function addUser(username, password, level) {
            if (!username || !password || !level) return "Dados inválidos.";
            if (config.users[username]) return `Usuário '${username}' já existe.`;
            config.users[username] = { password, level: parseInt(level, 10) };
            return `Usuário '${username}' criado com sucesso.`;
        }
        function addDoor(name, requiredLevel) {
            const lowerName = name.toLowerCase();
            if (!name || !requiredLevel) return "Dados inválidos.";
            if (config.doors[lowerName]) return `Porta '${name}' já existe.`;
            config.doors[lowerName] = { status: "FECHADA", requiredLevel: parseInt(requiredLevel, 10) };
            return `Porta '${name}' criada com sucesso.`;
        }
        function sendEmail(from, to, subject, body) {
            if (!from || !to || !subject || !body) return "Todos os campos são obrigatórios.";
            if (!config.users[to]) return `Destinatário '${to}' não encontrado.`;
            const newId = "E" + String(config.emails.length + 1).padStart(3, '0');
            config.emails.push({ id: newId, from, to, subject, body });
            return `Email enviado para '${to}' com sucesso.`;
        }

        // ==========================================================================
        // UI RENDERING FUNCTIONS
        // ==========================================================================
        function renderViewContainer(viewName, headerText, contentHtml, hints) {
            let html = `
                <div class="view-container" data-view="${viewName}">
                    <div class="view-header-section">
                        <div class="view-header-content">
                            <div class="view-header">${headerText}</div>
                            ${state.message.text ? `<div class="message ${state.message.type}">${state.message.text}</div>` : ''}
                            ${contentHtml}
                        </div>
                    </div>
                    <div class="footer-hints">${hints}</div>
                </div>`;
            output.innerHTML = html;
        }

        function renderWelcomeScreen() {
            let content = `
                <div class="description-text">${config.companyName} ${config.systemName}</div>
                <div class="description-text">Bem-vindo ao terminal seguro.</div>
                <div class="info-line">Pressione ENTER para iniciar sessão...</div>`;
            let fullHtml = `
                <div class="view-container" data-view="welcome">
                    <div class="view-header-content" style="text-align: center;">
                        ${content}
                    </div>
                    <div class="footer-hints">[ENTER] Continuar</div>
                </div>`;
            output.innerHTML = fullHtml;
        }

        function renderLoginScreen() {
            const form = state.loginForm;
            const userValueClass = state.activeInputField === 'username' ? 'cursor' : '';
            const passValueClass = state.activeInputField === 'password' ? 'cursor' : '';
            const userFieldClass = state.selectedIndex === 0 ? 'selected' : '';
            const passFieldClass = state.selectedIndex === 1 ? 'selected' : '';
            let content = `
                <div class="input-field ${userFieldClass}">
                    <span class="label">Usuário:</span>
                    <span class="value ${userValueClass}">${form.username}</span>
                </div>
                <div class="input-field ${passFieldClass}">
                    <span class="label">Senha:</span>
                    <span class="value ${passValueClass}">${'*'.repeat(form.password.length)}</span>
                </div>
                <div class="divider"></div>
                <div class="info-line" style="font-size: 0.9em; opacity: 0.8;">Use ↑/↓ para alternar campos.</div>`;
            renderViewContainer('login', 'AUTENTICAÇÃO', content, '[ENTER] Login | [ESC] Sair');
        }

        function renderMainMenu() {
            const menuItems = [
                { text: "Status do Sistema", view: 'status' },
                { text: "Ver Emails", view: 'email_list' },
                { text: "Controle de Portas", view: 'door_list' },
                { text: "Informações do Usuário", view: 'user_info' },
            ];
            if (state.currentLevel === 3) {
                menuItems.push({ text: "Administração do Sistema", view: 'admin_menu' });
            }
            menuItems.push({ text: "Logout", action: 'logout' });

            let content = menuItems.map((item, index) =>
                `<div class="menu-item ${index === state.selectedIndex ? 'selected' : ''}"><span class="text-bold">${item.text}</span></div>`
            ).join('');
            renderViewContainer('main_menu', `MENU PRINCIPAL [${state.currentUser} - Nível ${state.currentLevel}]`, content, '[↑/↓] Navegar | [ENTER] Selecionar | [ESC] Logout');
        }
        
        function renderEmailList() {
            const visibleEmails = config.emails.filter(email =>
                email.from === state.currentUser || email.to === state.currentUser || state.currentUser === 'root'
            );
            state.viewData.emails = visibleEmails; // Store filtered emails for selection logic

            let content = '';
            if (visibleEmails.length === 0) {
                content = `<div class="info-line">Nenhum email na sua caixa de entrada.</div>`;
            } else {
                content = visibleEmails.map((email, index) => {
                    const selectedClass = index === state.selectedIndex ? 'selected' : '';
                    const idFormatted = `[${email.id.padEnd(5)}]`;
                    const fromFormatted = email.from.padEnd(22, ' ');
                    const subjectPreviewLength = 35;
                    const subjectFormatted = email.subject.length > subjectPreviewLength ? email.subject.substring(0, subjectPreviewLength - 3) + "..." : email.subject;
                    const emailDisplayHtml = `<span class="text-bold">${idFormatted}</span> De: ${fromFormatted} | Assunto: ${subjectFormatted}`;
                    return `<div class="list-item ${selectedClass}">${emailDisplayHtml}</div>`;
                }).join('');
            }
            renderViewContainer('email_list', 'Caixa de Entrada', content, '[↑/↓] Navegar | [ENTER] Ler Email | [ESC] Voltar');
        }
        
        function renderEmailContent() {
            const email = config.emails.find(e => e.id === state.viewData.selectedEmailId);
            let content = '';
            if (!email) {
                displayMessage("Erro: Email não encontrado.", "error");
                setTimeout(navigateBack, 50);
                return;
            }
            // Visibility check is already done in renderEmailList, but double-check for safety
            const canSee = email.from === state.currentUser || email.to === state.currentUser || state.currentUser === 'root';
            if (!canSee) {
                 displayMessage("ERRO: Acesso a este email foi revogado.", "error");
                 setTimeout(navigateBack, 50);
                 return;
            }
            
            content = `
                <div class="info-line">De      : ${email.from}</div>
                <div class="info-line">Para    : ${email.to}</div>
                <div class="info-line">Assunto : ${email.subject}</div>
                <div class="divider"></div>
                <div class="description-text" style="white-space: pre-wrap;">${email.body}</div>`;
            renderViewContainer('email_read', `LENDO EMAIL: ${email.id}`, content, '[ESC] Voltar para Lista');
        }

        function renderDoorList() {
            state.viewData.doors = Object.entries(config.doors).map(([name, data]) => ({ name, ...data }));
            let content = '';
            if (state.viewData.doors.length === 0) {
                content = `<div class="info-line">Nenhuma porta configurada no sistema.</div>`;
            } else {
                content = state.viewData.doors.map((door, index) => {
                    const selectedClass = index === state.selectedIndex ? 'selected' : '';
                    const canAccess = door.requiredLevel <= state.currentLevel;
                    const namePad = 15;
                    const statusPad = 8;
                    let doorText;
                    if (canAccess) {
                        const nameFormatted = door.name.toUpperCase().padEnd(namePad);
                        const statusFormatted = door.status.padEnd(statusPad);
                        const statusStyle = door.status === 'ABERTA' ? `style="color: var(--warning-yellow); text-shadow: 0 0 var(--glow-blur) var(--warning-yellow);"` : '';
                        doorText = `Porta: <span class="text-bold">${nameFormatted}</span> | Nível: ${door.requiredLevel} | Status: <span ${statusStyle}>${statusFormatted}</span>`;
                    } else {
                        const placeholder = `[Nv.${door.requiredLevel} Bloqueado]`.padEnd(7 + namePad + 9 + 1 + 9 + statusPad, '▓');
                        doorText = `<span class="glitched-text" data-original-text="${placeholder}"></span>`;
                    }
                    return `<div class="list-item ${selectedClass}">${doorText}</div>`;
                }).join('');
            }
            renderViewContainer('door_list', 'Controle de Portas', content, '[↑/↓] Navegar | [ENTER] Interagir | [ESC] Voltar');
        }
        
        // --- ADMIN VIEWS ---
        function renderAdminMenu() {
            const menuItems = [
                { text: "Gerenciar Usuários", view: 'admin_users' },
                { text: "Gerenciar Portas", view: 'admin_doors' },
                { text: "Enviar Email", view: 'admin_send_email' },
                { text: "Voltar ao Menu Principal", action: 'back' }
            ];
            let content = menuItems.map((item, index) =>
                `<div class="menu-item ${index === state.selectedIndex ? 'selected' : ''}"><span class="text-bold">${item.text}</span></div>`
            ).join('');
            renderViewContainer('admin_menu', 'PAINEL DE ADMINISTRAÇÃO', content, '[↑/↓] Navegar | [ENTER] Selecionar | [ESC] Voltar');
        }
        
        function renderAdminForm(formConfig) {
            const form = state.adminForm;
            let content = formConfig.fields.map((field, index) => {
                const value = form[field.id] || "";
                const valueDisplay = field.type === 'password' ? '*'.repeat(value.length) : value;
                const fieldClass = state.selectedIndex === index ? 'selected' : '';
                const valueClass = state.activeInputField === field.id ? 'cursor' : '';
                return `
                    <div class="input-field ${fieldClass}">
                        <span class="label">${field.label}:</span>
                        <span class="value ${valueClass}">${valueDisplay}</span>
                    </div>`;
            }).join('');
            
            if (formConfig.textArea) {
                 const value = form[formConfig.textArea.id] || "";
                 const fieldClass = state.selectedIndex === formConfig.fields.length ? 'selected' : '';
                 const valueClass = state.activeInputField === formConfig.textArea.id ? 'cursor' : '';
                 content += `
                    <div class="input-field ${fieldClass}">
                         <span class="label">${formConfig.textArea.label}:</span>
                    </div>
                    <textarea id="email-body-textarea" class="email-body ${valueClass}" spellcheck="false">${value}</textarea>
                 `;
            }

            content += `<div class="divider"></div>`;
            renderViewContainer(formConfig.view, formConfig.header, content, formConfig.hints);
            
            // Special handling for textarea focus
            if (formConfig.textArea && state.activeInputField === formConfig.textArea.id) {
                const textarea = document.getElementById('email-body-textarea');
                if(textarea) {
                    textarea.focus();
                    textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
                }
            }
        }
        
        // ==========================================================================
        // RENDER DISPATCH
        // ==========================================================================
        function render() {
            const view = state.currentView;
            if (view.startsWith('admin_')) {
                handleAdminRender();
                return;
            }
            switch (view) {
                case 'welcome': renderWelcomeScreen(); break;
                case 'login': renderLoginScreen(); break;
                case 'login_result': renderLoginResultScreen(); break; // This is a special case, not using renderViewContainer
                case 'main_menu': renderMainMenu(); break;
                case 'status': renderStatusScreen(); break; // Needs to be created
                case 'email_list': renderEmailList(); break;
                case 'email_read': renderEmailContent(); break;
                case 'door_list': renderDoorList(); break;
                case 'door_detail': renderDoorDetail(); break; // Needs to be created
                case 'user_info': renderUserInfo(); break; // Needs to be created
                case 'admin_menu': renderAdminMenu(); break;
                default: output.innerHTML = `<div class="message error">Erro: View desconhecida - ${view}</div>`;
            }
        }
        
        function handleAdminRender() {
            let formConfig;
            switch(state.currentView) {
                case 'admin_users_add':
                    formConfig = {
                        view: 'admin_users_add', header: 'ADICIONAR NOVO USUÁRIO', hints: '[ENTER] Criar | [ESC] Cancelar',
                        fields: [
                            { id: 'username', label: 'Usuário', type: 'text' },
                            { id: 'password', label: 'Senha', type: 'password' },
                            { id: 'level', label: 'Nível (1-3)', type: 'number' }
                        ]
                    };
                    renderAdminForm(formConfig);
                    break;
                case 'admin_doors_add':
                    formConfig = {
                        view: 'admin_doors_add', header: 'ADICIONAR NOVA PORTA', hints: '[ENTER] Criar | [ESC] Cancelar',
                        fields: [
                            { id: 'name', label: 'Nome Porta', type: 'text' },
                            { id: 'level', label: 'Nível Req.', type: 'number' }
                        ]
                    };
                    renderAdminForm(formConfig);
                    break;
                case 'admin_send_email':
                     formConfig = {
                        view: 'admin_send_email', header: 'ENVIAR NOVO EMAIL', hints: '[ENTER] Enviar | [ESC] Cancelar',
                        fields: [
                            { id: 'to', label: 'Para (user)', type: 'text' },
                            { id: 'subject', label: 'Assunto', type: 'text' }
                        ],
                        textArea: { id: 'body', label: 'Corpo do Email' }
                    };
                    renderAdminForm(formConfig);
                    break;
                default:
                    // Fallback for list views or menu
                    if (state.currentView === 'admin_menu') renderAdminMenu();
                    else if (state.currentView === 'admin_users') renderItemList('Usuários', Object.keys(config.users), 'admin_users_add', 'admin_menu');
                    else if (state.currentView === 'admin_doors') renderItemList('Portas', Object.keys(config.doors), 'admin_doors_add', 'admin_menu');
                    break;
            }
        }
        
        function renderItemList(title, items, addView, backView) {
            let content = items.map(item => `<div class="list-item" style="padding-left:0;">- ${item}</div>`).join('');
            content += `<div class="divider"></div>`;
            content += `<div class="menu-item ${state.selectedIndex === 0 ? 'selected' : ''}">Adicionar Novo</div>`;
            content += `<div class="menu-item ${state.selectedIndex === 1 ? 'selected' : ''}">Voltar</div>`;
            renderViewContainer(title, `GERENCIAR ${title.toUpperCase()}`, content, '[↑/↓] Navegar | [ENTER] Selecionar');
        }

        // Dummy/uncreated views from original code
        function renderStatusScreen() {
            let openDoors = Object.values(config.doors).filter(d => d.status === "ABERTA").length;
            const visibleEmails = config.emails.filter(e => e.from === state.currentUser || e.to === state.currentUser || state.currentUser === 'root').length;
            let content = `
                <div class="info-line">Sistema         : ${config.systemName}</div>
                <div class="info-line">Usuário Atual   : ${state.currentUser}</div>
                <div class="info-line">Nível de Acesso : ${state.currentLevel}</div>
                <div class="divider"></div>
                <div class="info-line">Portas Abertas  : ${openDoors} / ${Object.keys(config.doors).length}</div>
                <div class="info-line">Emails Visíveis : ${visibleEmails} / ${config.emails.length}</div>`;
            renderViewContainer('status', 'Status do Sistema', content, '[ESC] Voltar');
        }
        function renderDoorDetail() {
            const doorName = state.viewData.selectedDoorName;
            const door = config.doors[doorName];
            if (!door) { navigateBack(); return; }
            const canInteract = door.requiredLevel <= state.currentLevel;
            let content = `
                <div class="info-line">Status Atual    : ${door.status}</div>
                <div class="info-line">Nível Necessário: ${door.requiredLevel}</div>
                <div class="divider"></div>`;
            if (!canInteract) {
                content += `<div class="message error">ACESSO NEGADO</div>`;
            }
            const menuItems = canInteract ? [
                { text: (door.status === "FECHADA" ? "Abrir Porta" : "Fechar Porta"), action: 'toggle' },
                { text: "Voltar", action: 'back' }
            ] : [{ text: "Voltar", action: 'back' }];
            content += menuItems.map((item, index) => `<div class="menu-item ${index === state.selectedIndex ? 'selected' : ''}">${item.text}</div>`).join('');
            renderViewContainer('door_detail', `PORTA: ${doorName.toUpperCase()}`, content, '[↑/↓] Navegar | [ENTER] Selecionar | [ESC] Voltar');
        }
        function renderUserInfo() {
            let content = `
                <div class="info-line">Usuário Logado: ${state.currentUser}</div>
                <div class="info-line">Nome Completo : [RESTRITO]</div>
                <div class="info-line">Nível Acesso  : ${state.currentLevel}</div>
                <div class="info-line">Organização   : ${config.companyName}</div>`;
            renderViewContainer('user_info', 'Informações do Usuário', content, '[ESC] Voltar');
        }
        function renderLoginResultScreen() {
            const isSuccess = state.loginSuccess;
            const resultClass = isSuccess ? 'success' : 'error';
            const messageText = isSuccess ? 'PERMITIDO' : 'NEGADO';
            const asciiArt = isSuccess ? accessGranted : accessDenied;
            output.innerHTML = `
                <div class="login-result-container">
                    <div class="result-box ${resultClass}">
                        <div class="result-message">${messageText}</div>
                        <div class="ascii-art">${asciiArt}</div>
                        <div class="continue-prompt">Pressione ENTER para continuar...</div>
                    </div>
                </div>`;
        }

        // ==========================================================================
        // BUSINESS LOGIC
        // ==========================================================================
        function attemptLogin() {
            const { username, password } = state.loginForm;
            const user = config.users[username];
            state.loginSuccess = user && user.password === password;
            if (state.loginSuccess) {
                state.loggedIn = true;
                state.currentUser = username;
                state.currentLevel = user.level;
            }
            navigateTo('login_result', {}, false);
        }

        function logout() {
            state.loggedIn = false;
            state.currentUser = null;
            state.currentLevel = 0;
            state.navigationStack = [];
            state.loginForm = { username: "", password: "" };
            state.activeInputField = 'username';
            navigateTo('login', {}, false);
            displayMessage("Logout realizado.", "info");
        }
        
        function toggleDoorAction(doorName) {
            const door = config.doors[doorName];
            if (!door || door.requiredLevel > state.currentLevel) return;
            door.status = door.status === 'ABERTA' ? 'FECHADA' : 'ABERTA';
            displayMessage(`Porta '${doorName.toUpperCase()}' agora está ${door.status}.`, 'success');
            render();
        }

        // ==========================================================================
        // EVENT HANDLERS
        // ==========================================================================
        document.addEventListener('keydown', (e) => {
            if (state.isAnimating) { e.preventDefault(); return; }
            if (document.activeElement !== terminal && !document.querySelector('textarea:focus')) {
                terminal.focus();
            }

            // Text input handling for forms
            if (state.currentView.includes('login') || state.currentView.includes('admin')) {
                if (handleFormInput(e)) {
                    e.preventDefault();
                    return;
                }
            }

            // General navigation
            switch (e.key) {
                case 'ArrowUp': handleSelectionChange(-1); e.preventDefault(); break;
                case 'ArrowDown': handleSelectionChange(1); e.preventDefault(); break;
                case 'Enter': handleEnterKey(); e.preventDefault(); break;
                case 'Escape': handleEscapeKey(); e.preventDefault(); break;
            }
        });
        
        function handleFormInput(e) {
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'Enter' || e.key === 'Escape' || e.ctrlKey || e.altKey || e.metaKey) {
                return false;
            }
            
            const isLogin = state.currentView === 'login';
            const isForm = state.currentView.includes('add') || state.currentView.includes('send_email');

            if (!isLogin && !isForm) return false;

            let form, fields, textArea;
            if (isLogin) {
                form = state.loginForm;
                fields = [{id: 'username'}, {id: 'password'}];
            } else { // Admin form
                form = state.adminForm;
                const config = getAdminFormConfig();
                fields = config.fields;
                textArea = config.textArea;
            }
            
            if (!state.activeInputField) return true; // Block other keys if no field is active

            if (e.key === 'Backspace') {
                if (state.activeInputField === textArea?.id) {
                    const textarea = document.getElementById('email-body-textarea');
                    if(textarea) state.adminForm.body = textarea.value;
                } else if (form[state.activeInputField] && form[state.activeInputField].length > 0) {
                    form[state.activeInputField] = form[state.activeInputField].slice(0, -1);
                }
            } else if (e.key.length === 1) {
                if (state.activeInputField === textArea?.id) {
                    const textarea = document.getElementById('email-body-textarea');
                    if(textarea) state.adminForm.body = textarea.value;
                } else {
                    form[state.activeInputField] = (form[state.activeInputField] || '') + e.key;
                }
            } else if (e.key === ' ' && state.activeInputField === textArea?.id) {
                 const textarea = document.getElementById('email-body-textarea');
                 if(textarea) state.adminForm.body = textarea.value;
            }

            render();
            return true;
        }
        
        function handleSelectionChange(direction) {
            const view = state.currentView;
            let itemCount = 0;
            let fields = [];

            if (view === 'login') {
                itemCount = 2;
                fields = ['username', 'password'];
            } else if (view === 'main_menu') {
                itemCount = 5 + (state.currentLevel === 3 ? 1 : 0);
            } else if (view === 'email_list') {
                itemCount = state.viewData.emails.length;
            } else if (view === 'door_list') {
                itemCount = state.viewData.doors.length;
            } else if (view === 'door_detail') {
                itemCount = document.querySelectorAll('.menu-item').length;
            } else if (view === 'admin_menu') {
                itemCount = 4;
            } else if (view === 'admin_users' || view === 'admin_doors') {
                itemCount = 2;
            } else if (view.includes('add') || view.includes('send_email')) {
                const config = getAdminFormConfig();
                itemCount = config.fields.length + (config.textArea ? 1 : 0);
                fields = config.fields.map(f => f.id);
                if (config.textArea) fields.push(config.textArea.id);
            }

            if (itemCount > 0) {
                state.selectedIndex = (state.selectedIndex + direction + itemCount) % itemCount;
                if (fields.length > 0) {
                    state.activeInputField = fields[state.selectedIndex];
                }
                render();
            }
        }

        function handleEnterKey() {
            const view = state.currentView;
            const index = state.selectedIndex;

            switch (view) {
                case 'welcome': navigateTo('login'); break;
                case 'login': attemptLogin(); break;
                case 'login_result':
                    if (state.loginSuccess) navigateTo('main_menu');
                    else navigateTo('login', {}, false);
                    break;
                case 'main_menu':
                    const menuItems = [ 'status', 'email_list', 'door_list', 'user_info' ];
                    if (state.currentLevel === 3) menuItems.push('admin_menu');
                    menuItems.push('logout');
                    const action = menuItems[index];
                    if (action === 'logout') logout();
                    else navigateTo(action);
                    break;
                case 'email_list':
                    if (state.viewData.emails.length > index) {
                        navigateTo('email_read', { selectedEmailId: state.viewData.emails[index].id });
                    }
                    break;
                case 'door_list':
                    if (state.viewData.doors.length > index) {
                        const door = state.viewData.doors[index];
                        if (door.requiredLevel <= state.currentLevel) {
                            navigateTo('door_detail', { selectedDoorName: door.name });
                        } else {
                            displayMessage("Acesso Negado.", "error");
                        }
                    }
                    break;
                case 'door_detail':
                    const doorItems = document.querySelectorAll('.menu-item');
                    if (doorItems[index]?.textContent.includes('Voltar')) navigateBack();
                    else toggleDoorAction(state.viewData.selectedDoorName);
                    break;
                case 'admin_menu':
                    const adminActions = ['admin_users', 'admin_doors', 'admin_send_email', 'back'];
                    if (adminActions[index] === 'back') navigateBack();
                    else navigateTo(adminActions[index]);
                    break;
                case 'admin_users':
                case 'admin_doors':
                    if (index === 0) navigateTo(view + '_add');
                    else navigateBack();
                    break;
                case 'admin_users_add':
                    const { username, password, level } = state.adminForm;
                    const userMsg = addUser(username, password, level);
                    displayMessage(userMsg, userMsg.includes('sucesso') ? 'success' : 'error');
                    if (userMsg.includes('sucesso')) navigateBack();
                    break;
                case 'admin_doors_add':
                    const { name, level: doorLevel } = state.adminForm;
                    const doorMsg = addDoor(name, doorLevel);
                    displayMessage(doorMsg, doorMsg.includes('sucesso') ? 'success' : 'error');
                    if (doorMsg.includes('sucesso')) navigateBack();
                    break;
                case 'admin_send_email':
                    const { to, subject } = state.adminForm;
                    const body = document.getElementById('email-body-textarea').value;
                    const emailMsg = sendEmail(state.currentUser, to, subject, body);
                    displayMessage(emailMsg, emailMsg.includes('sucesso') ? 'success' : 'error');
                    if (emailMsg.includes('sucesso')) navigateBack();
                    break;
            }
        }

        function handleEscapeKey() {
            if (state.currentView.includes('add') || state.currentView.includes('detail') || state.currentView.includes('read') || state.currentView.startsWith('admin_')) {
                navigateBack();
            } else {
                switch (state.currentView) {
                    case 'login': navigateTo('welcome', {}, false); break;
                    case 'main_menu': logout(); break;
                    case 'status': case 'email_list': case 'door_list': case 'user_info':
                        navigateBack();
                        break;
                }
            }
        }
        
        function getAdminFormConfig() {
             switch(state.currentView) {
                case 'admin_users_add': return { fields: [{id:'username'}, {id:'password'}, {id:'level'}] };
                case 'admin_doors_add': return { fields: [{id:'name'}, {id:'level'}] };
                case 'admin_send_email': return { fields: [{id:'to'}, {id:'subject'}], textArea: {id:'body'} };
                default: return { fields: [] };
             }
        }

        // ==========================================================================
        // INITIALIZATION
        // ==========================================================================
        function initializeData() {
            // Doors
            addDoor("Principal", 1);
            addDoor("Laboratorio", 2);
            addDoor("Servidor", 3);
            config.doors['servidor'].status = "ABERTA"; // Set initial status after creation
            addDoor("Cofre", 3);

            // Emails - Now with from/to for privacy
            sendEmail("root", "admin", "Protocolos Iniciais", "Admin, sistema online. Monitore todas as comunicações. Root.");
            sendEmail("admin", "convidado", "Boas-vindas", "Convidado, seu acesso é limitado. Reporte qualquer anomalia. - Admin");
            sendEmail("s.torvik@ses.com.br", "root", "Atualização 'Quimera'", "Root, a rede neural 'Quimera' está instável. Recomendo observação direta. - Dr. Torvik");
            // Add dummy users for flavor emails
            config.users['s.torvik@ses.com.br'] = {password: 'dummy', level: 2};
            config.users['d.ferreira@ses.com.br'] = {password: 'dummy', level: 2};
            sendEmail("d.ferreira@ses.com.br", "admin", "Manutenção Agendada", "Admin, a manutenção dos servidores ocorrerá na sexta. Backups são essenciais. - D. Ferreira, TI");
        }

        function init() {
            initializeData();
            navigateTo('welcome', {}, false);
            terminal.focus();
            
            // Set initial active field for login
            const loginFields = ['username', 'password'];
            state.activeInputField = loginFields[state.selectedIndex];
        }

        window.addEventListener('resize', () => {
            if (!state.isAnimating) {
                render();
                if (state.currentView === 'email_list' || state.currentView === 'door_list') {
                    startGlitchEffect();
                }
            }
        });

        // --- Start the application ---
        init();
    </script>

</body>
</html>
